<div id="category-select-container">
    <div class="mb-3">
        <label class="form-label">Категории</label>
        <div class="d-none">
            <!-- Скрытый оригинальный select для формы -->
            <select name="category" id="id_category" class="d-none" multiple>
                {% for category in categories %}
                <option value="{{ category.id }}" {% if category in selected_categories %}selected{% endif %}>
                    {{ category.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Кастомный dropdown -->
        <div class="custom-select-wrapper border rounded bg-white">
            <!-- Выбранные элементы и кнопка разворачивания -->
            <div class="selected-tags p-2 border-bottom d-flex flex-wrap align-items-center">
                {% for category in selected_categories %}
                <span class="badge bg-primary me-1 mb-1">
                    {{ category.name }}
                    <span class="remove-tag" data-category-id="{{ category.id }}">×</span>
                </span>
                {% endfor %}
                <div class="flex-grow-1"></div>
                <button type="button" class="btn btn-sm btn-outline-secondary toggle-options-btn ms-2">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>

            <!-- Поиск и options (изначально скрыты) -->
            <div class="dropdown-content" style="display: none;">
                <!-- Поле поиска -->
                <div class="p-2 border-bottom">
                    <input type="text" class="form-control form-control-sm search-categories-input"
                           placeholder="Поиск категорий...">
                </div>

                <!-- Dropdown options с кнопками -->
                <div class="custom-options-list" style="max-height: 200px; overflow-y: auto;">
                    {% for category in categories %}
                    <div class="custom-option d-flex justify-content-between align-items-center p-2 border-bottom {% if category in selected_categories %}bg-light{% endif %}"
                         data-category-id="{{ category.id }}" data-category-name="{{ category.name|lower }}">
                        <div class="form-check mb-0 flex-grow-1">
                            <input type="checkbox" class="form-check-input category-checkbox"
                                   value="{{ category.id }}"
                                   {% if category in selected_categories %}checked{% endif %}>
                            <label class="form-check-label">{{ category.name }}</label>
                        </div>
                        <div class="option-actions">
                            <button type="button" class="btn btn-outline-primary btn-sm me-1 edit-category-btn"
                                    data-category-id="{{ category.id }}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-sm delete-category-btn"
                                    data-category-id="{{ category.id }}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Скрытое поле для передачи выбранных категорий в модальное окно -->
        <input type="hidden" name="current_categories" id="current_categories" value="{% for cat in selected_categories %}{{ cat.id }},{% endfor %}">
    </div>
</div>

<script>
// Функция для полной очистки модальных окон
function cleanupModals() {
    // Закрываем все модальные окна
    const modals = document.querySelectorAll('.modal.show');
    modals.forEach(modal => {
        modal.classList.remove('show');
        modal.style.display = 'none';
    });

    // Удаляем все backdrop
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => {
        backdrop.remove();
    });

    // Восстанавливаем body
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
}

// Обработчик для успешного создания категории
document.addEventListener('htmx:afterOnLoad', function(event) {
    if (event.detail.requestConfig.path.includes('/create-category/') &&
        event.detail.xhr.status === 200) {
        setTimeout(cleanupModals, 150);
    }
});

// Также обрабатываем клик по кнопке отмены
document.addEventListener('click', function(event) {
    if (event.target.closest('[data-bs-dismiss="modal"]')) {
        setTimeout(cleanupModals, 150);
    }
});

// Инициализация кастомного select
function initCustomSelect() {
    const originalSelect = document.getElementById('id_category');

    // Функция переключения видимости списка
    function toggleOptions() {
        const dropdownContent = document.querySelector('.dropdown-content');
        const toggleButton = document.querySelector('.toggle-options-btn');

        if (dropdownContent && toggleButton) {
            const isVisible = dropdownContent.style.display === 'block';
            if (isVisible) {
                dropdownContent.style.display = 'none';
                toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i>';
                toggleButton.classList.remove('btn-primary');
                toggleButton.classList.add('btn-outline-secondary');
            } else {
                dropdownContent.style.display = 'block';
                toggleButton.innerHTML = '<i class="fas fa-chevron-up"></i>';
                toggleButton.classList.remove('btn-outline-secondary');
                toggleButton.classList.add('btn-primary');
                // Фокусируемся на поле поиска при открытии
                const searchInput = document.querySelector('.search-categories-input');
                if (searchInput) {
                    setTimeout(() => searchInput.focus(), 100);
                }
            }
        }
    }

    // Делегирование событий для кнопки разворачивания
    document.addEventListener('click', function(e) {
        // Обработка кнопки разворачивания
        if (e.target.closest('.toggle-options-btn')) {
            e.preventDefault();
            e.stopPropagation();
            toggleOptions();
            return;
        }

        // Обработка кнопок редактирования
        if (e.target.closest('.edit-category-btn')) {
            e.preventDefault();
            e.stopPropagation();
            const button = e.target.closest('.edit-category-btn');
            const categoryId = button.dataset.categoryId;
            alert(`Редактирование категории ID: ${categoryId}`);
            openCategoryModal('edit', categoryId);
            return;
        }

        // Обработка кнопок удаления
        if (e.target.closest('.delete-category-btn')) {
            e.preventDefault();
            e.stopPropagation();
            const button = e.target.closest('.delete-category-btn');
            const categoryId = button.dataset.categoryId;
            alert(`Удаление категории ID: ${categoryId}`);
            return;
        }

        // Обработка удаления тегов
        if (e.target.closest('.remove-tag')) {
            e.preventDefault();
            e.stopPropagation();
            const removeBtn = e.target.closest('.remove-tag');
            const categoryId = removeBtn.dataset.categoryId;
            const checkbox = document.querySelector(`.category-checkbox[value="${categoryId}"]`);
            if (checkbox) {
                checkbox.checked = false;
                checkbox.dispatchEvent(new Event('change'));
            }
            return;
        }

        // Клик по option (кроме кнопок) - переключает выбор
        if (e.target.closest('.custom-option') && !e.target.closest('.option-actions')) {
            e.preventDefault();
            e.stopPropagation();
            const option = e.target.closest('.custom-option');
            const checkbox = option.querySelector('.category-checkbox');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event('change'));
            }
            return;
        }

        // Закрытие dropdown при клике вне его
        if (!e.target.closest('.custom-select-wrapper')) {
            const dropdownContent = document.querySelector('.dropdown-content');
            const toggleButton = document.querySelector('.toggle-options-btn');
            if (dropdownContent && toggleButton) {
                dropdownContent.style.display = 'none';
                toggleButton.innerHTML = '<i class="fas fa-chevron-down"></i>';
                toggleButton.classList.remove('btn-primary');
                toggleButton.classList.add('btn-outline-secondary');
            }
        }
    });

    // Обработчик для поиска
    const searchInput = document.querySelector('.search-categories-input');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const options = document.querySelectorAll('.custom-option');

            options.forEach(option => {
                const categoryName = option.dataset.categoryName;
                if (categoryName.includes(searchTerm)) {
                    option.classList.remove('hidden');
                } else {
                    option.classList.add('hidden');
                }
            });
        });
    }

    // Обработчики для checkbox
    document.querySelectorAll('.category-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectedCategories();
        });
    });

    // Инициализация при загрузке
    updateSelectedCategories();
}

// Обновление выбранных категорий
function updateSelectedCategories() {
    const selectedCheckboxes = document.querySelectorAll('.category-checkbox:checked');
    const selectedTagsContainer = document.querySelector('.selected-tags');
    const originalSelect = document.getElementById('id_category');

    if (!selectedTagsContainer) return;

    // Сохраняем кнопку разворачивания
    const toggleButton = selectedTagsContainer.querySelector('.toggle-options-btn');

    // Обновляем теги
    const tagsHTML = Array.from(selectedCheckboxes).map(checkbox => {
        const categoryId = checkbox.value;
        const categoryName = checkbox.nextElementSibling.textContent;
        return `<span class="badge bg-primary me-1 mb-1">
            ${categoryName} <span class="remove-tag" data-category-id="${categoryId}">×</span>
        </span>`;
    }).join('');

    selectedTagsContainer.innerHTML = tagsHTML;

    // Добавляем кнопку разворачивания обратно
    if (toggleButton) {
        selectedTagsContainer.appendChild(toggleButton);
    } else {
        // Создаем кнопку, если её нет
        const newToggleButton = document.createElement('button');
        newToggleButton.type = 'button';
        newToggleButton.className = 'btn btn-sm btn-outline-secondary toggle-options-btn ms-2';
        newToggleButton.innerHTML = '<i class="fas fa-chevron-down"></i>';
        selectedTagsContainer.appendChild(newToggleButton);
    }

    // Обновляем оригинальный select
    Array.from(originalSelect.options).forEach(option => {
        const isChecked = Array.from(selectedCheckboxes).some(checkbox => checkbox.value === option.value);
        option.selected = isChecked;
    });

    // Обновляем визуальное выделение
    document.querySelectorAll('.custom-option').forEach(option => {
        const checkbox = option.querySelector('.category-checkbox');
        if (checkbox && checkbox.checked) {
            option.classList.add('bg-light');
        } else {
            option.classList.remove('bg-light');
        }
    });

    // Обновляем hidden поле для модального окна
    updateCurrentCategories();
}

// Функция для обновления текущих выбранных категорий
function updateCurrentCategories() {
    const selectedValues = Array.from(document.querySelectorAll('.category-checkbox:checked'))
        .map(checkbox => checkbox.value);
    const currentCategoriesInput = document.getElementById('current_categories');
    if (currentCategoriesInput) {
        currentCategoriesInput.value = selectedValues.join(',');
    }
}

// Функция для открытия модального окна
function openCategoryModal(mode, categoryId = null) {
    let url;

    if (mode === 'edit' && categoryId) {
        url = `{% url "blogs:edit_category" 0 %}`.replace('0', categoryId);
    } else {
        url = '{% url "blogs:create_category" %}';
    }

    updateCurrentCategories();

    htmx.ajax('GET', url, '#categoryModal .modal-content')
        .then(() => {
            const modal = new bootstrap.Modal(document.getElementById('categoryModal'));
            modal.show();
        });
}

// Инициализация при загрузке
document.addEventListener('DOMContentLoaded', function() {
    initCustomSelect();
});

// Обработчик для HTMX
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'category-select-container') {
        setTimeout(initCustomSelect, 100);
    }
});
</script>